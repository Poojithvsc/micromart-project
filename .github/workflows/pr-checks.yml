# =============================================================================
# MicroMart - Pull Request Checks Workflow
# =============================================================================
# Triggered on pull requests to main branch.
# Provides additional validation before merging.
#
# Learning Points:
# - PR labeling based on files changed
# - Automated code review hints
# - Changelog validation
# - Branch naming conventions
# =============================================================================

name: PR Checks

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, labeled, unlabeled]

permissions:
  contents: read
  pull-requests: write

jobs:
  # ---------------------------------------------------------------------------
  # Label PR Based on Changed Files
  # ---------------------------------------------------------------------------
  labeler:
    name: Label PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Label PR
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml

  # ---------------------------------------------------------------------------
  # Validate PR Title (Conventional Commits)
  # ---------------------------------------------------------------------------
  validate-title:
    name: Validate PR Title
    runs-on: ubuntu-latest

    steps:
      - name: Check PR Title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          subjectPattern: ^.{1,80}$
          subjectPatternError: |
            The subject must be no longer than 80 characters.
          ignoreLabels: |
            bot
            dependencies

  # ---------------------------------------------------------------------------
  # Check for Breaking Changes
  # ---------------------------------------------------------------------------
  breaking-changes:
    name: Check Breaking Changes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for API Changes
        run: |
          # Check if any controller files were modified
          CHANGED_CONTROLLERS=$(git diff --name-only origin/main...HEAD | grep -E "Controller\.java$" || true)

          if [ -n "$CHANGED_CONTROLLERS" ]; then
            echo "## API Changes Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The following controller files were modified:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$CHANGED_CONTROLLERS" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please ensure API changes are backward compatible or properly versioned." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for Database Migrations
        run: |
          # Check for schema changes
          SCHEMA_CHANGES=$(git diff --name-only origin/main...HEAD | grep -E "(schema\.sql|migration|\.sql)$" || true)

          if [ -n "$SCHEMA_CHANGES" ]; then
            echo "## Database Schema Changes Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The following migration files were modified:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$SCHEMA_CHANGES" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please ensure migrations are backward compatible." >> $GITHUB_STEP_SUMMARY
          fi

  # ---------------------------------------------------------------------------
  # Size Check
  # ---------------------------------------------------------------------------
  size-check:
    name: PR Size Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR Size
        run: |
          # Get number of changed lines
          ADDITIONS=$(git diff --numstat origin/main...HEAD | awk '{s+=$1} END {print s+0}')
          DELETIONS=$(git diff --numstat origin/main...HEAD | awk '{s+=$2} END {print s+0}')
          TOTAL=$((ADDITIONS + DELETIONS))

          echo "## PR Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lines Added | +${ADDITIONS} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lines Deleted | -${DELETIONS} |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Changes | ${TOTAL} |" >> $GITHUB_STEP_SUMMARY

          if [ "$TOTAL" -gt 1000 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ **Large PR Warning**: This PR has more than 1000 lines changed." >> $GITHUB_STEP_SUMMARY
            echo "Consider breaking it into smaller PRs for easier review." >> $GITHUB_STEP_SUMMARY
          fi

  # ---------------------------------------------------------------------------
  # Dependency Check
  # ---------------------------------------------------------------------------
  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Check for Dependency Updates
        run: |
          mvn versions:display-dependency-updates -DprocessAllModules=true > dependency-updates.txt 2>&1 || true

          if grep -q "The following dependencies in" dependency-updates.txt; then
            echo "## Dependency Updates Available" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run \`mvn versions:display-dependency-updates\` to see available updates." >> $GITHUB_STEP_SUMMARY
          fi

  # ---------------------------------------------------------------------------
  # PR Summary
  # ---------------------------------------------------------------------------
  summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [validate-title, breaking-changes, size-check]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Title Validation | ${{ needs.validate-title.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Breaking Changes | ${{ needs.breaking-changes.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Size Check | ${{ needs.size-check.result }} |" >> $GITHUB_STEP_SUMMARY
